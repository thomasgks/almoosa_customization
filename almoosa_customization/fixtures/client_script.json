[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2026-02-16 02:28:09.548772",
  "module": "Almoosa Customization",
  "name": "Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\r\n    onload: function(frm) {\r\n        \r\n        // âœ… Default Stock Entry Type for NEW documents only\r\n        if (frm.is_new() && !frm.doc.stock_entry_type) {\r\n            frm.set_value(\"stock_entry_type\", \"Material Transfer\");\r\n            frm.set_value('add_to_transit', 1);\r\n        }\r\n\r\n        toggle_transit_fields(frm);\r\n\r\n        // âœ… Only run on new Stock Entry created from End Transit\r\n        if (\r\n            frm.doc.docstatus === 0 &&\r\n            frm.doc.stock_entry_type === \"Material Transfer\" &&\r\n            frm.doc.outgoing_stock_entry\r\n        ) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"Stock Entry\",\r\n                    name: frm.doc.outgoing_stock_entry\r\n                },\r\n                callback(r) {\r\n                    if (!r.message) return;\r\n\r\n                    let source_doc = r.message;\r\n\r\n                    if (source_doc.custom_receiving_warehouse) {\r\n                        frm.set_value(\"to_warehouse\", source_doc.custom_receiving_warehouse);\r\n                    }\r\n\r\n                    if (source_doc.to_warehouse) {\r\n                        frm.set_value(\"from_warehouse\", source_doc.to_warehouse);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    },\r\n\r\n    refresh: function(frm) {\r\n\r\n        toggle_transit_fields(frm);\r\n        frm.trigger(\"calculate_total_qty\");\r\n        \r\n        // âœ… Detect & map Material Request â†’ Stock Entry (SAFE ADDITION)\r\n        apply_material_request_mapping(frm);\r\n\r\n        // 1ï¸âƒ£ Get Warehouse permissions\r\n        let user_perms = frappe.boot.user.user_permissions;\r\n\r\n        if (user_perms && user_perms['Warehouse']) {\r\n\r\n            let raw_perms = user_perms['Warehouse'];\r\n            let allowed_warehouses = [];\r\n\r\n            if (Array.isArray(raw_perms)) {\r\n                allowed_warehouses = raw_perms.map(p => p.doc);\r\n            } else if (raw_perms.docs) {\r\n                allowed_warehouses = raw_perms.docs;\r\n            } else {\r\n                allowed_warehouses = raw_perms;\r\n            }\r\n\r\n            console.log(\"Allowed Warehouses:\", allowed_warehouses);\r\n\r\n            // ðŸ”’ from_warehouse permission filter (EXISTING LOGIC)\r\n            if (allowed_warehouses.length > 0) {\r\n                frm.set_query('from_warehouse', function () {\r\n                    return {\r\n                        filters: [\r\n                            ['Warehouse', 'name', 'in', allowed_warehouses]\r\n                        ]\r\n                    };\r\n                });\r\n            }\r\n\r\n            // âœ… Default from_warehouse for Material Transfer\r\n            if (\r\n                frm.is_new() &&\r\n                frm.doc.stock_entry_type === \"Material Transfer\" &&\r\n                !frm.doc.from_warehouse &&\r\n                allowed_warehouses.length > 0\r\n            ) {\r\n                frm.set_value(\"from_warehouse\", allowed_warehouses[0]);\r\n            }\r\n        }\r\n\r\n        // ðŸ” Apply correct to_warehouse logic\r\n        set_to_warehouse_query_based_on_type(frm);\r\n    },\r\n\r\n    add_to_transit: function(frm) {\r\n        toggle_transit_fields(frm);\r\n    },\r\n\r\n    stock_entry_type: function(frm) {\r\n        enforce_warehouse_requirements(frm);\r\n        set_to_warehouse_query_based_on_type(frm);\r\n        frm.trigger(\"calculate_total_qty\");\r\n    },\r\n\r\n    validate: function(frm) {\r\n        enforce_warehouse_requirements(frm);\r\n        check_required_warehouses(frm);\r\n    },\r\n\r\n    calculate_total_qty: function(frm) {\r\n\r\n        if (frm.doc.docstatus !== 0) return;\r\n        if (!frm.is_dirty()) return;\r\n\r\n        let total = 0;\r\n\r\n        if (frm.doc.stock_entry_type === \"Material Transfer\") {\r\n            (frm.doc.items || []).forEach(row => {\r\n                total += row.qty || 0;\r\n            });\r\n        }\r\n\r\n        frm.set_value(\"custom_total_quantity\", total);\r\n    }\r\n});\r\n\r\nfunction apply_material_request_mapping(frm) {\r\n\r\n    // Only for NEW draft Stock Entries\r\n    if (!frm.is_new() || frm.doc.docstatus !== 0) return;\r\n\r\n    // Prevent re-running\r\n    if (frm.__mr_applied) return;\r\n\r\n    let mr_name = null;\r\n\r\n    // ðŸ” Detect Material Request from item rows (ONLY reliable method)\r\n    (frm.doc.items || []).forEach(row => {\r\n        if (row.material_request) {\r\n            mr_name = row.material_request;\r\n        }\r\n    });\r\n\r\n    if (!mr_name) return; // âŒ Not created from Material Request\r\n\r\n    frm.__mr_applied = true;\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"Material Request\",\r\n            name: mr_name\r\n        },\r\n        callback(r) {\r\n            if (!r.message) return;\r\n\r\n            let mr = r.message;\r\n\r\n            // âœ… Force Material Transfer\r\n            frm.set_value(\"stock_entry_type\", \"Material Transfer\");\r\n\r\n            // âœ… Enable & lock Add to Transit\r\n            frm.set_value(\"add_to_transit\", 1);\r\n            frm.set_df_property(\"add_to_transit\", \"read_only\", 1);\r\n\r\n            // âœ… Warehouse mapping (AS REQUESTED)\r\n            if (mr.set_from_warehouse) {\r\n                frm.set_value(\r\n                    \"from_warehouse\",\r\n                    mr.set_from_warehouse\r\n                );\r\n            }\r\n\r\n            if (mr.set_warehouse) {\r\n                frm.set_value(\r\n                    \"custom_receiving_warehouse\",\r\n                    mr.set_warehouse\r\n                );\r\n            }\r\n\r\n            // ðŸ” Re-apply your existing logic safely\r\n            toggle_transit_fields(frm);\r\n            enforce_warehouse_requirements(frm);\r\n            set_to_warehouse_query_based_on_type(frm);\r\n\r\n            frm.refresh_fields([\r\n                \"stock_entry_type\",\r\n                \"add_to_transit\",\r\n                \"custom_receiving_warehouse\",\r\n                \"from_warehouse\"\r\n            ]);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* ðŸ” WAREHOUSE QUERY HANDLER (NEW â€“ SAFE ADDITION)                    */\r\n/* ------------------------------------------------------------------ */\r\nfunction set_to_warehouse_query_based_on_type(frm) {\r\n\r\n    // ðŸ”¥ HARD RESET any ERPNext/internal query\r\n    frm.fields_dict.to_warehouse.get_query = null;\r\n\r\n    let user_perms = frappe.boot.user.user_permissions;\r\n    if (!user_perms || !user_perms['Warehouse']) return;\r\n\r\n    let raw_perms = user_perms['Warehouse'];\r\n    let allowed_warehouses = [];\r\n\r\n    if (Array.isArray(raw_perms)) {\r\n        allowed_warehouses = raw_perms.map(p => p.doc);\r\n    } else if (raw_perms.docs) {\r\n        allowed_warehouses = raw_perms.docs;\r\n    } else {\r\n        allowed_warehouses = raw_perms;\r\n    }\r\n\r\n    // âœ… MATERIAL RECEIPT â†’ ALL permitted warehouses\r\n    if (frm.doc.stock_entry_type === \"Material Receipt\") {\r\n\r\n        frm.set_query('to_warehouse', function () {\r\n            return {\r\n                filters: [\r\n                    ['Warehouse', 'name', 'in', allowed_warehouses]\r\n                ]\r\n            };\r\n        });\r\n\r\n        // ðŸ” Force refresh so UI picks new query\r\n        frm.refresh_field('to_warehouse');\r\n    }\r\n\r\n    // ðŸ” Other types â†’ allow ERPNext default behavior\r\n    else {\r\n        frm.fields_dict.to_warehouse.get_query = null;\r\n        frm.refresh_field('to_warehouse');\r\n    }\r\n}\r\n\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* ðŸ” REQUIREMENTS & VALIDATIONS                                      */\r\n/* ------------------------------------------------------------------ */\r\nfunction enforce_warehouse_requirements(frm) {\r\n\r\n    const type = frm.doc.stock_entry_type;\r\n\r\n    frm.set_df_property('from_warehouse', 'reqd', false);\r\n    frm.set_df_property('to_warehouse', 'reqd', false);\r\n    frm.set_df_property('add_to_transit', 'read_only', false);\r\n\r\n    if (type === \"Material Transfer\") {\r\n\r\n        frm.set_df_property('from_warehouse', 'reqd', true);\r\n        frm.set_df_property('to_warehouse', 'reqd', true);\r\n\r\n        if (!frm.doc.outgoing_stock_entry) {\r\n            frm.set_value('add_to_transit', 1);\r\n            frm.set_df_property('add_to_transit', 'read_only', true);\r\n        }\r\n\r\n    } else if (type === \"Material Receipt\") {\r\n\r\n        frm.set_df_property('to_warehouse', 'reqd', true);\r\n        frm.set_value('add_to_transit', 0);\r\n        frm.set_df_property('add_to_transit', 'read_only', false);\r\n        frm.set_value('from_warehouse', null);\r\n\r\n    } else if (type === \"Material Issue\") {\r\n\r\n        frm.set_df_property('from_warehouse', 'reqd', true);\r\n        frm.set_value('add_to_transit', 0);\r\n        frm.set_df_property('add_to_transit', 'read_only', false);\r\n    }\r\n}\r\n\r\nfunction check_required_warehouses(frm) {\r\n\r\n    const type = frm.doc.stock_entry_type;\r\n\r\n    if (type === \"Material Transfer\") {\r\n        if (!frm.doc.from_warehouse || !frm.doc.to_warehouse) {\r\n            frappe.throw(__('Both Source and Target Warehouses are required for Material Transfer'));\r\n        }\r\n    } else if (type === \"Material Receipt\") {\r\n        if (!frm.doc.to_warehouse) {\r\n            frappe.throw(__('Target Warehouse is required for Material Receipt'));\r\n        }\r\n    } else if (type === \"Material Issue\") {\r\n        if (!frm.doc.from_warehouse) {\r\n            frappe.throw(__('Source Warehouse is required for Material Issue'));\r\n        }\r\n    }\r\n}\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* ðŸ”„ TRANSIT FIELD VISIBILITY                                        */\r\n/* ------------------------------------------------------------------ */\r\nfunction toggle_transit_fields(frm) {\r\n\r\n    const isTransit = frm.doc.add_to_transit;\r\n\r\n    frm.set_df_property('custom_column_break_q7cde', 'hidden', !isTransit);\r\n    frm.set_df_property('custom_receiving_warehouse', 'hidden', !isTransit);\r\n    frm.set_df_property('custom_receiving_warehouse', 'reqd', !!isTransit);\r\n}\r\n\r\n/* ------------------------------------------------------------------ */\r\n/* ðŸ“¦ ITEM EVENTS                                                     */\r\n/* ------------------------------------------------------------------ */\r\nfrappe.ui.form.on('Stock Entry Detail', {\r\n\r\n    qty: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        \r\n        // Validation: Check against MR qty limit\r\n        if (row.material_request_item && row.material_request) {\r\n            frappe.call({\r\n                method: 'almoosa_customization.api.get_mr_item_remaining_qty',\r\n                args: {\r\n                    material_request_item: row.material_request_item,\r\n                    current_row_name: row.name,\r\n                    current_qty: row.qty\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message !== undefined && row.qty > r.message) {\r\n                        // Show detailed message for qty exceed\r\n                        frappe.msgprint({\r\n                            title: __('Quantity Exceeded'),\r\n                            message: __('Item <b>{0}</b> qty <b>{1}</b> exceeds remaining qty <b>{2}</b> in Material Request <b>{3}</b>.', \r\n                                [row.item_code, row.qty, r.message, frm.doc.custom_material_request]),\r\n                            indicator: 'red'\r\n                        });\r\n                        \r\n                        // Auto-adjust to max allowed\r\n                        frappe.model.set_value(cdt, cdn, 'qty', r.message);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        \r\n        frm.trigger(\"calculate_total_qty\");\r\n    },\r\n\r\n    items_remove(frm) {\r\n        frm.trigger(\"calculate_total_qty\");\r\n    },\r\n\r\n    item_code: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        \r\n        // Skip if item_code is being cleared or empty\r\n        if (!row.item_code) {\r\n            return;\r\n        }\r\n        \r\n        // Skip if already processing this row\r\n        if (frm._processing_item === cdn) {\r\n            return;\r\n        }\r\n        frm._processing_item = cdn;\r\n\r\n        // Only proceed if custom_material_request exists\r\n        if (!frm.doc.custom_material_request) {\r\n            // Just get attributes if no MR\r\n            frappe.call({\r\n                method: \"almoosa_customization.api.get_item_attributes\",\r\n                args: { item_code: row.item_code },\r\n                callback: function(r) {\r\n                    if (r.message) {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_color', r.message.color);\r\n                        frappe.model.set_value(cdt, cdn, 'custom_size', r.message.size);\r\n                    }\r\n                    frm._processing_item = null;\r\n                }\r\n            });\r\n            return;\r\n        }\r\n        \r\n        // Build used_mr_items array\r\n        let used_mr_items = [];\r\n        let used_qty_map = {};\r\n        \r\n        frm.doc.items.forEach(item => {\r\n            if (item.name !== row.name && item.material_request_item) {\r\n                used_mr_items.push(item.material_request_item);\r\n                used_qty_map[item.material_request_item] = (used_qty_map[item.material_request_item] || 0) + (item.qty || 0);\r\n            }\r\n        });\r\n        \r\n        // Call API to get MR item\r\n        frappe.call({\r\n            method: 'almoosa_customization.api.get_mr_item_for_scan',\r\n            args: {\r\n                material_request: frm.doc.custom_material_request,\r\n                item_code: row.item_code,\r\n                used_items: JSON.stringify(used_mr_items),\r\n                used_qty_map: JSON.stringify(used_qty_map)\r\n            },\r\n            callback: function(r) {\r\n                console.log(r.message);\r\n                \r\n                if (r.message && r.message.found) {\r\n                    const mr_item = r.message;\r\n                    \r\n                    // VALID ITEM - Set attributes first\r\n                    frappe.call({\r\n                        method: \"almoosa_customization.api.get_item_attributes\",\r\n                        args: { item_code: row.item_code },\r\n                        callback: function(attr_r) {\r\n                            if (attr_r.message) {\r\n                                frappe.model.set_value(cdt, cdn, 'custom_color', attr_r.message.color);\r\n                                frappe.model.set_value(cdt, cdn, 'custom_size', attr_r.message.size);\r\n                            }\r\n                        }\r\n                    });\r\n                    \r\n                    frappe.model.set_value(cdt, cdn, 'material_request', frm.doc.custom_material_request);\r\n                    frappe.model.set_value(cdt, cdn, 'material_request_item', mr_item.name);\r\n                    \r\n                    // Check if entered qty exceeds remaining\r\n                    let entered_qty = row.qty || 1;\r\n                    if (entered_qty > mr_item.remaining_qty) {\r\n                        // Show detailed message for qty exceed on item scan\r\n                        frappe.msgprint({\r\n                            title: __('Quantity Exceeded'),\r\n                            message: __('Item <b>{0}</b> entered qty <b>{1}</b> exceeds remaining qty <b>{2}</b> in Material Request <b>{3}</b>. Adjusted to maximum.', \r\n                                [row.item_code, entered_qty, mr_item.remaining_qty, frm.doc.custom_material_request]),\r\n                            indicator: 'red'\r\n                        });\r\n                        entered_qty = mr_item.remaining_qty;\r\n                    }\r\n                    \r\n                    frappe.model.set_value(cdt, cdn, 'qty', entered_qty);\r\n                    \r\n                    frappe.show_alert({\r\n                        message: __('Mapped to MR line. Max qty: {0}', [mr_item.remaining_qty]),\r\n                        indicator: 'green'\r\n                    }, 3);\r\n                    \r\n                    frm._processing_item = null;\r\n                    \r\n                } else {\r\n                    // INVALID ITEM - Remove the row completely\r\n                    frappe.msgprint({\r\n                        title: __('Invalid Item'),\r\n                        message: __('Item <b>{0}</b> is not in Material Request <b>{1}</b>.', \r\n                            [row.item_code, frm.doc.custom_material_request]),\r\n                        indicator: 'red'\r\n                    });\r\n                    \r\n                    // Remove the row\r\n                    delete locals[cdt][cdn];\r\n                    frm.doc.items = frm.doc.items.filter(item => item.name !== cdn);\r\n                    frm.refresh_field('items');\r\n                    frm.fields_dict.items.grid.refresh();\r\n                    frm.trigger(\"calculate_total_qty\");\r\n                    \r\n                    frm._processing_item = null;\r\n                }\r\n            },\r\n            error: function() {\r\n                frm._processing_item = null;\r\n            }\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]